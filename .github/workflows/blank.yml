name: Jira GitHub Deploy Test

on:
  push:
    branches:
      - "*"
  workflow_dispatch:

# GITHUB_TOKEN 권한 – 이거 없으면 deployments 못 만들 수 있음
permissions:
  contents: read
  deployments: write

jobs:
  build:
    name: Build (test only)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dummy build
        run: |
          echo "==== Build Start ===="
          echo "여기에 실제 빌드/테스트 스크립트를 넣으면 됩니다."
          echo "예: npm ci && npm test"
          echo "==== Build End ===="

  deploy:
    name: Deploy (record only for Jira)
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) GitHub Deployment 생성
      - name: Create deployment
        id: create_deployment
        uses: chrnorm/deployment-action@v2.0.5   # 또는 releases/v2
        with:
          # ✅ 이전에 에러났던 부분: token 반드시 넣어야 함
          token: ${{ github.token }}             # 별도 PAT 없이 기본 GITHUB_TOKEN 사용
          environment: staging                   # 필요하면 production 등으로 변경
          ref: ${{ github.sha }}

      # 2) Deployment 상태 success 로 업데이트
      - name: Set deployment status
        uses: chrnorm/deployment-status@v2.0.0   # 또는 releases/v2
        with:
          token: ${{ github.token }}
          state: success
          deployment_id: ${{ steps.create_deployment.outputs.deployment_id }}
