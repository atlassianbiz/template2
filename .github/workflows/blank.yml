name: Jira GitHub Deploy Test

on:
  push:
    branches:
      - "*"
  workflow_dispatch:

# GITHUB_TOKEN ê¶Œí•œ â€“ ì´ê±° ì—†ìœ¼ë©´ deployments ëª» ë§Œë“¤ ìˆ˜ ìˆìŒ
permissions:
  contents: read
  deployments: write

jobs:
  build:
    name: Build (test only)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dummy build
        run: |
          echo "==== Build Start ===="
          echo "ì—¬ê¸°ì— ì‹¤ì œ ë¹Œë“œ/í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤."
          echo "ì˜ˆ: npm ci && npm test"
          echo "==== Build End ===="

  deploy:
    name: Deploy (record only for Jira)
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) GitHub Deployment ìƒì„±
      - name: Create GitHub deployment
        id: deployment
        uses: chrnorm/deployment-action@v2   # ë‚´ë¶€ì ìœ¼ë¡œ v2.x.x ì‚¬ìš©
        with:
          token: ${{ github.token }}
          environment: staging              # í•„ìš” ì‹œ production ë“±ìœ¼ë¡œ ë³€ê²½
          ref: ${{ github.sha }}

      # 2) Deployment ìƒíƒœ success ë¡œ ì—…ë°ì´íŠ¸
      - name: Update deployment status (success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          state: success
          # ğŸ”´ ì—¬ê¸°! ì…ë ¥ ì´ë¦„ì€ deployment-id (kebab-case)
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}

      # (ì„ íƒ) ì‹¤íŒ¨ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸ í•˜ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ë„ ì¶”ê°€ ê°€ëŠ¥
      # - name: Update deployment status (failure)
      #   if: failure()
      #   uses: chrnorm/deployment-status@v2
      #   with:
      #     token: ${{ github.token }}
      #     state: failure
      #     deployment-id: ${{ steps.deployment.outputs.deployment_id }}
