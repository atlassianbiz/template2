name: Jira GitHub Deploy Test

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dummy build
        run: |
          echo "Build step for Jira/GitHub deploy test"
          echo "여기에서 실제 빌드/테스트를 수행할 수 있습니다."

  deploy:
    # build 성공 후에만 실행
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) GitHub Deployment 생성
      - name: Create deployment
        id: create_deployment
        uses: chrnorm/deployment-action@releases/v1
        with:
          # Jira에서 환경 이름으로 보이는 값 (dev / test / staging / production 중 하나 권장)
          environment: staging
          # 어떤 커밋을 배포했는지
          ref: ${{ github.sha }}

      # 2) Deployment Status 전송 (Jira는 이 이벤트를 기준으로 배포를 인식함)
      - name: Set deployment status (success)
        uses: chrnorm/deployment-status@releases/v1
        with:
          state: success
          deployment_id: ${{ steps.create_deployment.outputs.deployment_id }}
          # 선택 옵션들(있으면 Jira에서 링크로 보이기 좋음)
          environment_url: https://example.com/staging
          log_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
