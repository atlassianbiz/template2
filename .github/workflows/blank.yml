name: Jira GitHub Deploy Test

on:
  push:
    branches:
      - "*"
  workflow_dispatch:

# GITHUB_TOKEN 권한
permissions:
  contents: read
  deployments: write

jobs:
  build:
    name: Build (test only)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dummy build
        run: |
          echo "==== Build Start ===="
          echo "여기에 실제 빌드/테스트 스크립트를 넣으면 됩니다."
          echo "예: npm ci && npm test"
          echo "==== Build End ===="

  deploy:
    name: Deploy (record only for Jira)
    needs: build           # 빌드 성공 후에만 실행
    runs-on: ubuntu-latest

    steps:
      # ✅ GitHub Deployment 생성 (Jira는 이 이벤트를 기준으로 배포를 인식)
      - name: Create deployment
        id: create_deployment
        uses: chrnorm/deployment-action@releases/v1
        with:
          token: ${{ github.token }}   # 별도 secret 없이 GITHUB_TOKEN만 사용
          environment: staging
          ref: ${{ github.sha }}

      # ✅ Deployment 상태 success 로 업데이트
      - name: Set deployment status
        uses: chrnorm/deployment-status@releases/v1
        with:
          token: ${{ github.token }}
          state: success
          deployment_id: ${{ steps.create_deployment.outputs.deployment_id }}

      # 예시) set-output 대신 GITHUB_OUTPUT 사용 예 (필요한 경우)
      # - name: Set example output
      #   run: echo "example_output=some_value" >> $GITHUB_OUTPUT
